<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exibir texto de PDF</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }
    #pdfText {
        white-space: pre-wrap;
    }
</style>
</head>
<body>

<div class="container">
    <h1 class="mt-5">Conta descontos cartão</h1>
    <div class="row mt-4">
        <div class="col-md-6">
            <label for="fileInput" class="form-label">Selecione o arquivo PDF:</label>
            <input type="file" id="fileInput" class="form-control" accept=".pdf">
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-3">
            <label for="numBanco" class="form-label">Código do banco:</label>
            <input type="number" id="numBanco" class="form-control">
        </div>
        <div class="col-md-3">
            <label for="banco" class="form-label">Nome do banco:</label>
            <input type="text" id="banco" class="form-control">
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-3">
            <button onclick="lerArq()" class="btn btn-primary">Calcular</button>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <div id="pdfText" class="mt-4"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
<script>
var escreve = false;
var doc = [];
var contador = 0;
var soma = 0.0;
function lerArq() {
    var file = document.getElementById('fileInput').files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
        var typedarray = new Uint8Array(e.target.result);
        parsePDF(typedarray);
    };
    reader.readAsArrayBuffer(file);
}

function parsePDF(data) {
    doc = [];
    pdfjsLib.getDocument(data).promise.then(function(pdf) {
        var maxPages = pdf.numPages; // número total de páginas no PDF
        var pageNumber = 1; // começando da primeira página
        renderPage(pdf, pageNumber, maxPages);
    });
}

function renderPage(pdf, pageNumber, maxPages) {
	
    if (pageNumber > maxPages)
	{
		calc();
		return; 
	}// termina se todas as páginas foram processadas

    pdf.getPage(pageNumber).then(function(page) {
        page.getTextContent().then(function(textContent) {
            let textItems = textContent.items;
            let finalText = [];
            for (let i = 0; i < textItems.length; i++) {
                let item = textItems[i];
		if(!escreve && item.str!="DESCONTOS DE CARTÃO") continue;
		escreve=true;
                finalText += item.str + ';';

		if(item.str=="ANUAL") finalText=";";
            }	
		if(escreve) doc = doc.concat(finalText.split(numBanco.value));
            renderPage(pdf, pageNumber + 1, maxPages);
        });
    });
}

function calc()
{
	contador = 0;
	soma = 0.0;
	doc.forEach((item)=>{
	dados = item.split(";");
	if(dados[0].toLowerCase().includes(banco.value.toLowerCase())){
		soma += parseFloat(dados[5].replace("R$", "").replace(",", ""));
		contador++;
	}
	});
	document.getElementById('pdfText').textContent = "A soma é R$"+soma/100+" com "+contador+" descontos".replace(".",",");

}
</script>
</body>
</html>