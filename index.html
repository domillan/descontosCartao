<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Descontos de cartão RMC</title>
<link rel="icon" href="./img.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }
    #pdfText {
        white-space: pre-wrap;
    }
    
</style>
</head>
<body>

<div class="container">
    <h1 class="mt-5">Descontos de cartão RMC</h1>
<h6 class="text-secondary"><i>Em fase de testes</i></h6>
<h6 class="text-end">Feito por <a href="http://lattes.cnpq.br/6702944102751831">Daniel Millan</a></h6>
    <div class="row mt-4">
        <div class="col-md-6">
            <label for="fileInput" class="form-label">Selecione o arquivo PDF:</label>
            <input type="file" id="fileInput" class="form-control" accept=".pdf">
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-3">
            <label for="numBanco" class="form-label">Código do banco:</label>
            <input type="number" placeholder="000" required id="numBanco" class="form-control">
        </div>
        <div class="col-md-3">
            <label for="banco" class="form-label">Nome do banco:</label>
            <input type="text" placeholder="??" required id="banco" class="form-control">
        </div>
	<div class="col-md-3"> <button onclick="imagemBanco.classList.toggle('d-none');" class="bt-info btn btn-sm btn-outline-secondary">?</button>
	<img id="imagemBanco"  src="./cod banco.png" class="d-none rounded float-right position-absolute" style="max-width:450px;" alt="...">
      </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-6 ">
          <label class="form-check-label" for="datasDesc">
          Organizar por data: 
          </label>
            <input class="form-check-input" type="checkbox" checked id="datasDesc">
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-3">
            <button onclick="lerArq()" class="btn btn-primary"> Calcular</button>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <h4><div id="pdfText" class="mt-4"></div></h4>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <ul id="lista" class="list-group mt-4"></ul>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
<script>
var escreve = false;
var doc = [];
var contador = 0;
var soma = 0.0;


function lerArq() {
    var file = document.getElementById('fileInput').files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
        var typedarray = new Uint8Array(e.target.result);
        parsePDF(typedarray);
    };
    reader.readAsArrayBuffer(file);
}

function parsePDF(data) {
    doc = [];
    pdfjsLib.getDocument(data).promise.then(function(pdf) {
        var maxPages = pdf.numPages; // número total de páginas no PDF
        var pageNumber = 1; // começando da primeira página
        renderPage(pdf, pageNumber, maxPages);
    });
}

function renderPage(pdf, pageNumber, maxPages) {
	
    if (pageNumber > maxPages)
	{
		calc();
		return; 
	}// termina se todas as páginas foram processadas

    pdf.getPage(pageNumber).then(function(page) {
        page.getTextContent().then(function(textContent) {
            let textItems = textContent.items;
            let finalText = [];
            for (let i = 0; i < textItems.length; i++) {
                let item = textItems[i];
		    if(!escreve && item.str!="DESCONTOS DE CARTÃO") continue;
		    escreve=true;
                finalText += item.str + ';';

		if(item.str=="ANUAL") finalText=";";
            }	
		if(escreve){
			let lista = [];
			finalText.split(numBanco.value).forEach((paragraph)=>{
				while(paragraph.indexOf(";") != paragraph.indexOf(";R$"))
				{
				  paragraph = paragraph.replace(";", " ");
				}
				lista.push(paragraph);
			});
			doc = doc.concat(lista);
		}
            renderPage(pdf, pageNumber + 1, maxPages);
        });
    });
}

function calc()
{
    
    document.getElementById("lista").innerHTML = "";
    document.getElementById('pdfText').innerHTML = "";
	contador = 0;
	soma = 0.0;
    regex = /(\d{2})\/(\d{4})/;

    if(banco.value=="" || numBanco.value=="")
        return;

    if (datasDesc.checked == true)
    doc.sort(function(a,b)
        {
            dataA = a.split(";");
            dataB = b.split(";");
            if(dataA[3] === undefined || !regex.test(dataA[3]))
                dataA[3] = "0";
            if(dataB[3] === undefined || !regex.test(dataB[3]))
                dataB[3] = "0";
            return parseFloat(dataA[3].replace(regex, '$2$1')) - parseFloat(dataB[3].replace(regex, '$2$1'));  
            
        });

	doc.forEach((item)=>{
    	dados = item.split(";");
    	if(dados[0].toLowerCase().includes(banco.value.toLowerCase())){
    		soma += parseFloat(dados[5].replace("R$", "").replace(",", ""));
    		contador++;
            let paragrafo = document.createElement("li");
            if (datasDesc.checked == true)
              paragrafo.innerHTML = "<b>"+dados[5] + "</b> - " + dados[3];
            else
              paragrafo.innerHTML = "<b>"+dados[5] + "</b>";
            paragrafo.classList.add("list-group-item");
            document.getElementById("lista").append(paragrafo);
	}
	});
	document.getElementById('pdfText').innerHTML = ("O total é <b>R$ "+(soma/100).toFixed(2)+"</b> com <b>"+contador+"</b> descontos").replace(".",",");

}
</script>
</body>
</html>